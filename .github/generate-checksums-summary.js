const fs = require('fs');
const path = require('path');

const { appendFile } = fs.promises;

const { GITHUB_STEP_SUMMARY } = process.env;

const directoryPath = path.join(process.cwd(), 'release');

// Mapping of file names to friendly package names (matching release notes format)
const fileMappings = {
  'Redis-Insight-win-installer.exe': 'Windows',
  'Redis-Insight-linux-x86_64.AppImage': 'Linux AppImage',
  'Redis-Insight-linux-amd64.deb': 'Linux Debian',
  'Redis-Insight-linux-x86_64.rpm': 'Linux RPM',
  'Redis-Insight-mac-x64.dmg': 'MacOS Intel',
  'Redis-Insight-mac-arm64.dmg': 'MacOS Apple silicon',
};

// YAML files generated by electron-builder
const yamlFiles = ['latest.yml', 'latest-linux.yml', 'latest-mac.yml'];

/**
 * Simple YAML parser for electron-builder format
 * Extracts file entries with their sha512 values
 */
function parseYamlFile(content) {
  const files = [];
  const lines = content.split('\n');

  let currentFile = null;

  for (const line of lines) {
    // Match file URL entries like "  - url: Redis-Insight-win-installer.exe"
    const urlMatch = line.match(/^\s+-?\s*url:\s*(.+)$/);
    if (urlMatch) {
      currentFile = { url: urlMatch[1].trim() };
      continue;
    }

    // Match sha512 entries like "    sha512: base64hash=="
    const sha512Match = line.match(/^\s+sha512:\s*(.+)$/);
    if (sha512Match && currentFile) {
      currentFile.sha512 = sha512Match[1].trim();
      files.push(currentFile);
      currentFile = null;
    }
  }

  return files;
}

async function generateChecksumsSummary() {
  try {
    const checksums = [];

    // Parse each YAML file
    for (const yamlFile of yamlFiles) {
      const filePath = path.join(directoryPath, yamlFile);

      if (!fs.existsSync(filePath)) {
        console.log(`File not found: ${yamlFile}, skipping...`);
        continue;
      }

      const content = fs.readFileSync(filePath, 'utf8');
      const files = parseYamlFile(content);

      for (const file of files) {
        const packageName = fileMappings[file.url];
        if (packageName && file.sha512) {
          checksums.push({
            package: packageName,
            sha512: file.sha512,
          });
        }
      }
    }

    if (checksums.length === 0) {
      console.log('No checksums found in YAML files.');
      return;
    }

    // Sort checksums in a consistent order
    const order = Object.values(fileMappings);
    checksums.sort(
      (a, b) => order.indexOf(a.package) - order.indexOf(b.package),
    );

    // Generate Markdown table
    const markdownLines = [
      '',
      '## SHA-512 Checksums',
      '',
      '| Package | SHA-512 |',
      '|---------|---------|',
      ...checksums.map((c) => `| ${c.package} | ${c.sha512} |`),
      '',
    ];

    const data = markdownLines.join('\n');

    if (GITHUB_STEP_SUMMARY) {
      await appendFile(GITHUB_STEP_SUMMARY, data, { encoding: 'utf8' });
      console.log('Checksums summary generated successfully.');
    } else {
      // For local testing, print to console
      console.log(data);
    }
  } catch (error) {
    console.error('Error generating checksums summary:', error.message);
  }
}

generateChecksumsSummary();
